<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ConectaServ - Cliente</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="img/style.css">
</head>

<body>

  <nav class="navbar navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="index.html">ConectaServ</a>
      <img src="/static/img/logo.png" alt="logo ConectaServ" class="logo">
    </div>
  </nav>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Portal do Cliente</h2>

    <!-- Tela inicial -->
    <div id="inicioSection" class="text-center">
      <h4>Tem cadastro?</h4>
      <button class="btn btn-primary" onclick="irLogin()">Sim, fazer login</button>
      <button class="btn btn-secondary" onclick="irCadastro()">Não, quero me cadastrar</button>
    </div>

    <!-- ÁREA APÓS LOGIN DO CLIENTE -->
    <div id="pesquisaSection" class="d-none">
      <h3 id="boasVindas" class="text-primary"></h3>

      <h5>Pesquisar profissionais</h5>
      <input type="text" id="campoBusca" class="form-control mb-3" placeholder="Ex: Eletricista, encanador...">
      <button class="btn btn-primary mb-4" id="btn-buscar">Pesquisar</button>

      <div id="listaPrestadores" class="row gy-3"></div>

      <hr>

      <button class="btn btn-danger mt-3" onclick="logoutCliente()">Sair</button>
    </div>

  </div>

  <script>
    // ================================
    // Redirecionar para páginas
    // ================================
    function irLogin() {
      window.location.href = "login_cliente.html";
    }

    function irCadastro() {
      window.location.href = "cadastro_cliente.html";
    }

    // ================================
    // Exibir boas-vindas se logado
    // ================================
    window.onload = () => {
      const token = localStorage.getItem("token_cliente");
      const nome = localStorage.getItem("cliente_nome");

      if (token) {
        document.getElementById("inicioSection").classList.add("d-none");
        document.getElementById("pesquisaSection").classList.remove("d-none");
        document.getElementById("boasVindas").innerText = `Bem-vindo, ${nome}!`;
      }
      if (token) {
          document.getElementById("inicioSection").classList.add("d-none");
          document.getElementById("pesquisaSection").classList.remove("d-none");

          const nomeFinal = nome || "Prezado(a)";
          document.getElementById("boasVindas").innerText = `Bem-vindo(a), ${nomeFinal}!`;
}

    };

    // ================================
    // Logout
    // ================================
    function logoutCliente() {
      localStorage.removeItem("token_cliente");
      localStorage.removeItem("cliente_id");
      localStorage.removeItem("cliente_nome");
      window.location.reload();
    }

    // ================================
    // PESQUISAR PRESTADORES
    // ================================
    document.getElementById("btn-buscar").addEventListener("click", async () => {
      const termo = document.getElementById("campoBusca").value.trim();
      const token = localStorage.getItem("token_cliente");

      if (!termo) {
        alert("Digite uma profissão para pesquisar.");
        return;
      }

      try {
        const res = await fetch(`/api/provider/search?profissao=${encodeURIComponent(termo)}`, {
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.error || "Erro ao buscar profissionais");
          return;
        }

        renderPrestadores(data);

      } catch (error) {
        alert("Erro ao conectar ao servidor.");
      }
    });

    // ================================
    // EXIBIR PRESTADORES NA TELA
    // ================================
    function renderPrestadores(lista) {
      const container = document.getElementById("listaPrestadores");
      container.innerHTML = "";

      if (!lista.length) {
        container.innerHTML = `<p class="text-center text-danger">Nenhum profissional encontrado.</p>`;
        return;
      }

      lista.forEach(prest => {
        const card = document.createElement("div");
        card.className = "col-md-4";

        card.innerHTML = `
          <div class="card p-3 shadow-sm">
            <h5>${prest.nome}</h5>
            <p><strong>Profissão:</strong> ${prest.profissao}</p>
            <p>${prest.descricao || ""}</p>
            <button class="btn btn-primary btn-sm" onclick="abrirChat(${prest.id})">Conversar</button>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // ================================
    // ABRIR CHAT COM PRESTADOR
    // ================================
    function abrirChat(idPrestador) {
      localStorage.setItem("chat_provider_id", idPrestador);
      window.location.href = "chat_cliente.html";
    }

  </script>

  <script src="/static/cliente.js"></script>

</body>

<footer class="rodape">
  <p>ConectaServ - Todos os direitos reservados 2025</p>
</footer>

</html>
